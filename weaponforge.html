<!Doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Infiniforge</title>
    <link rel="stylesheet" href="Style/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="Style/forge_style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="Style/inventory_style.css" type="text/css" media="screen" />
</head>

<body>
    <div id="container">
        
        <header>
            <h1>Shi Johnson-Bey</h1>
            <h3>Graduate Student at Carnegie Mellon University</h3>
        </header>

        <nav>
            <ul id="nav">
                <li>
                    <a href="index.html">Home</a>
                </li>
                <li>
                    <a href="resume.html">Resume</a>
                </li>
                <li id="selected">
                    <a href="weaponforge.html">Infiniforge Game</a>
                </li>
            </ul>
        </nav>

        
        <div id="game-container">
            <div id="scene-pane">
                <canvas id="threejs-canvas"></canvas>
            </div>
            <div id="options-pane">
                <div id="item-options-pane">
                    <!--Holds all the tabs for inventory-->
                    <div class="tab">
                        <button class="tab-links" onclick="OpenTab(event, 'inventory')" id="default-open">Inventory</button>
                        <button class="tab-links" onclick="OpenTab(event, 'sword-stats')">Sword Stats</button>
                    </div>
                    <div id="inventory" class="tab-content">
                        <p>Inventory:</p>
                        <div id="player-inventory" class="inventory-table">
                            <div class="inventory-row">
                                <div class="inventory-cell">
                                    <div class="inventory-item iron-ingot tooltip" data-item-type="ingot"></div>
                                </div>
                                <div class="inventory-cell">
                                    <div class="inventory-item earth-ingot" data-item-type="ingot"></div>
                                </div>
                                <div class="inventory-cell"></div>
                                <div class="inventory-cell">
                                    <div class="inventory-item fire-ore" data-item-type="ore"></div>
                                </div>
                                <div class="inventory-cell">
                                    <div class="inventory-item fire-ore" data-item-type="ore"></div>
                                </div>
                            </div>
                            <div class="inventory-row">
                                <div class="inventory-cell"></div>
                                <div class="inventory-cell"></div>
                                <div class="inventory-cell"></div>
                                <div class="inventory-cell"></div>
                                <div class="inventory-cell"></div>
                            </div>
                        </div>
                    </div>
                    <div id="sword-stats" class="tab-content">
                        <table>
                            <p>Coming Soon!</p>
                            <!--
                            <tr>
                                <th>Name:</th>
                                <td id="stats-sword-name">Excalibur</td>
                            </tr>
                            <tr>
                                <th>Style:</th>
                                <td id="stats-sword-style">LongSword</td>
                            </tr>
                            -->
                        </table>
                    </div>
                </div>
                
                <div id="smelt-options">
                    <p>Drag and drop ore to smelt ingots</p>
                    <div id="smelt-items" class="inventory-table" data-item-filter-whitelist="ore" data-item-filter-blacklist="ingot">
                        <div class="inventory-row">
                            <div class="inventory-cell">
                            </div>
                            <div class="inventory-cell">
                            </div>
                        </div>
                    </div>
                    <button id="smelt-button" class="button" onclick="smeltOre()">Smelt</button>
                </div>
                <div id="forge-options">
                    <div class="dropdown">
                        <button id="forge-options-dropbtn" class="dropbtn" onclick="showForgeOptions()">Open Forge Options</button>
                        
                        <div id="forge-options-dropdown" class="dropdown-content">
                            <p>Sword Style:
                                <select id="sword-style" name="swordStyle" required>
                                    <option value="short">Short</option>
                                    <option value="long" selected="selected">Long</option>
                                    <option value="great">Great</option>
                                </select>
                            </p>

                            <p>Seed:
                                <input type="text" id="seed-value" placeholder="Random Seed" name="seed" />
                                <button id="random-seed-button" class="button" onclick="randomizeSeed()">Random Seed</button>
                            </p>

                            <p class="slide-container"> Blade Base Width (%):
                                <input type="range" min="1" max="50" value="30" class="slider" id="base-width">
                            </p>

                            <p class="slide-container"> Edge-Width Ratio (%):
                                <input type="range" min="10" max="100" value="20" class="slider" id="edge-width-ratio">
                            </p>

                            <p class="slide-container"> Blade Length:
                                <input type="range" min="1" max="6" value="3" class="slider" id="blade-length">
                            </p>
                        </div>
                    </div>
                    <p>Drag and drap ingots to forge a sword</p>
                        <div id="forge-items" class="inventory-table" data-item-filter-whitelist="ingot gem" data-item-filter-blacklist="ore">
                            <div class="inventory-row">
                                <div class="inventory-cell">
                                </div>
                                <div class="inventory-cell">
                                </div>
                            </div>
                        </div>
                        <button id="forge-button" class="button" onclick="forgeSword()">Forge!</button>
                </div>
            </div>
        </div>
        <section>
            <h2>How to Play </h2>
            <p>This game was designed to be an example of how a crafting system
                could utilize the procedural sword code.
            </p>
            <ol>
                <li><strong>Smelt Ore: </strong>Drag any of the colored ores into the two blocks. Creating an ingot requires two ore items</li>
                <li><strong>Select Your Ingots: </strong>Drag and drop two of the ingots created from the previous step.</li>
                <li><strong>Forge Your Blade: </strong>Click 'Open Forge Options' to configure your build. Click 'Forge' button when ready.</li>
            </ol>
        </section>
        
        <section>
            <h2>Recent Updates</h2>
            <h3>April 2018</h3>
            <ul>
                <li>New UI</li>
                <li>Items! Players can now smelt and Forge using items in their inventory!</li>
                <li>Fixed pseudo randomness of generation process</li>
            </ul>
        </section>
        <section>
            <h2>Features to Add</h2>
            <ul>
                <li>Show the item count in inventory</li>
                <li>Hover over item for more information</li>
                <li>Forge with the same ore or ingot</li>
                <li>Fix aspect ratio for 3d scene camera</li>
                <li>3d Scene Background</li>
                <li>Modify vertex colors depending on items and sword component</li>
                <li>Stats about the blade</li>
            </ul>
        </section>
        <section>
            <h2>Credits</h2>
            <ul>
                <li>Inventory system adapted from Eric Eastwood @ <a href="https://codepen.io/MadLittleMods/pen/vmhLF"> Inventory Sample Code</a></a></li>
                <li>W3Schools Web UI tutorials</li>
            </ul>
        </section>
    </div>
</body>

<script src="js/jquery.min.js" type="text/javascript"></script>
<script src="js/jquery-ui.min.js" type="text/javascript"></script>
<script src="js/jquery.lavaNav.js"></script>
<script type="text/javascript">$('#nav').lavaNav();</script>            
<script src="js/three.min.js"></script>
<script src="js/seedrandom.min.js"></script>
<script src="js/inventory-gui.js"></script>
<script src="js/swordgenerator.min.js"></script>
<script src="js/inventory.min.js"></script>

<script>
    $(".inventory-item").mouseenter(
        function () {
            console.log("hovering");
           var itemName = getItemName($(this).attr("class"));
           var itemStats = getItem(itemName);
           var itemHtml = statsToHtml(itemStats, playerInventory);
           $( this ).append( $( `<div class='tooltip'><span class='tooltiptext'>${itemHtml}</span></div>`) );
        }
        /*, function() {
            $( this ).find( ".tooltip" ).remove();
        }*/
    );
    $(".inventory-item").mouseleave(
        function () {
            $( this ).find( ".tooltip" ).remove();
        }
    );
    $()


</script>


<script>
    function randomizeSeed(seedLength = 7) {
        var seed = "";
        lowercaseAsciiOffset = 97;
        uppercaseAsciiOffset = 65;
        for (var i = 0; i < seedLength; i++) {
            var useLowerCase = Math.random() > .5;
            if (useLowerCase){
                seed += String.fromCharCode(lowercaseAsciiOffset + Math.round(Math.random() * 25))
            } else {
                seed += String.fromCharCode(uppercaseAsciiOffset + Math.round(Math.random() * 25))
            }
        }
        document.getElementById('seed-value').value = seed;
    }

    var styleSelector = document.getElementById('sword-style')
    styleSelector.addEventListener("change", () => {
        // Get the current value
        var selectedStyle = styleSelector.value;
        var requiredNumIngots = 1;
        if (selectedStyle == "short") {
            requiredNumIngots = 1;
        } else if (selectedStyle == "long") {
            requiredNumIngots = 2;
        } else if (selectedStyle == "great") {
            requiredNumIngots = 3;
        }
        console.log("Resizing the forge to require " + requiredNumIngots + " ingots.");
        // Resize the forge-item inventory space
        $('#forge-items.inventory-table').addRemoveItems(1);
        $('#forge-items.inventory-table .inventory-row').addRemoveItems(requiredNumIngots);
        refreshSortableInventoryList();
    });

    function showForgeOptions() {
        var dropdown = $("#forge-options-dropdown");
        dropdown.toggleClass("show");
        var forgeOptionsDropdownButton = $("#forge-options-dropbtn");
        if (dropdown.hasClass("show")) {
            forgeOptionsDropdownButton.html("Close Forge Options");
        } else {
            forgeOptionsDropdownButton.html("Open Forge Options");
        }
    }

    
    function OpenTab(event, tabName) {
        var i, tabContent, tabLinks;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; ++i) {
            tabContent[i].style.display = "none";
        }
        tabLinks = document.getElementsByClassName("tab-links");
        for (i = 0; i < tabLinks.length; ++i) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        event.currentTarget.className += " active";
    }
    document.getElementById("default-open").click();
</script>

<script>
    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function () {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
            } else {
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });
    }
</script>




<script type="text/javascript">
var scene, camera, renderer;
var swordModel, material;
var frustumSize = 1000;

function init() {
    var ThreeJSCanvas = document.getElementById("threejs-canvas");
    renderer = new THREE.WebGLRenderer({ canvas: ThreeJSCanvas, antialias: true });

    var aspect = ThreeJSCanvas.style.height / ThreeJSCanvas.style.width;
    //camera = new THREE.OrthographicCamera(frustumSize * aspect / -2, 
        //frustumSize * aspect / 2, frustumSize / 2, frustumSize / -2, 1, 100);
    camera = new THREE.PerspectiveCamera(75, .3, 1, 1000);
    camera.position.z = 7;

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    var light = new THREE.DirectionalLight(0xe6e6ff, 1);
    light.position.set(1, 1, 1).normalize();
    scene.add(light);
    
    var geometry = new THREE.BoxBufferGeometry(1, 1, 1);
    material = new THREE.MeshLambertMaterial( { color: 0xffffff } )
    swordModel = new THREE.Mesh(geometry, material);
    scene.add(swordModel);
    
    renderer.setPixelRatio(window.devicePixelRatio);
}

function forgeSword() {

    $('#sliding-door').animate({top:0}, 500,
    function() {

    });

    var style = document.getElementById('sword-style').value;
    // Check to make sure the correc tnumber of ingots were given
    var requiredNumIngots = 1;
    if (style == "short") {
            requiredNumIngots = 1;
        } else if (style == "long") {
            requiredNumIngots = 2;
        } else if (style == "great") {
            requiredNumIngots = 3;
    }
    // Get all the ingots passed for forging
    var itemsForForge = $('#forge-items.inventory-table .inventory-row .inventory-item');
    // stop if we don't have enough ingots
    if (itemsForForge.length < requiredNumIngots) {
        return
    }
    var seedVal = document.getElementById('seed-value').value;
    // Add the names of the the ingots to the seedVal
    for (var i = 0; i < itemsForForge.length; i++) {
        seedVal += getItemName(itemsForForge[i].className);
    }
    var basewidth = document.getElementById('base-width').value;
    var edgeWidthRatio = document.getElementById('edge-width-ratio').value;
    var bladeLength = document.getElementById('blade-length').value;
    
    var swordTemplate = {
        "baseWidth": basewidth / 100, "widthMarginRatio": (edgeWidthRatio / 100), "length": bladeLength
    };
    var generator = new SwordGenerator(seedVal, style, swordTemplate);
    sword = generator.generateSword();
    scene.remove(swordModel);
    swordModel = new THREE.Mesh(sword.geometry, material);
    swordModel.position.y = -3;
    scene.add(swordModel);

    for (var i = 0; i < itemsForForge.length; i++) {
        playerInventory.removeItem(getItemID(getItemName(itemsForForge[i].className)), 1);
    }
    playerInventory.render('player-inventory');
    // Clear the slots in the smelt inventory
    var cells = $("#forge-items.inventory-table  .inventory-cell"); 
    //console.log(cells.length);
    for (var i = 0; i < cells.length; i++) {
        while(cells[i].firstChild) {
            cells[i].removeChild(cells[i].firstChild);
        }
    }
}

function animate () {
    requestAnimationFrame(animate);
    swordModel.rotation.y += 0.05;
    renderer.render(scene, camera);
};

// This code is supposed to program the sliding door

init();
animate();
forgeSword();
</script>


</html>